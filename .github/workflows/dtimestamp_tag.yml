name: Timestamp and Tag

on:
  push:
    tags: 
      - 'v*'  # This will trigger the workflow for any tag that starts with v

jobs:
  get_timestamp_and_tag:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get latest Amazon Linux 2023 tag update timestamp
        id: get_timestamp
        run: |
          response=$(curl -s "https://hub.docker.com/v2/repositories/library/amazonlinux/tags/2023")
          timestamp=$(echo "$response" | jq -r '.last_updated')
          epoch_timestamp=$(date -d "$timestamp" +%s)
          echo "Latest epoch timestamp: $epoch_timestamp timestamp: $timestamp"
          echo "epoch_timestamp=$epoch_timestamp" >> $GITHUB_ENV

      - name: Create Git tag
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git tag "$GITHUB_ENV::epoch_timestamp"
          git push origin "$GITHUB_ENV::epoch_timestamp" -f